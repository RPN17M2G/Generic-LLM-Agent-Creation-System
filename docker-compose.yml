
services:
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - llm_network

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse_db
    ports:
      - "8123:8123"  # HTTP interface
      - "9000:9000"  # Native protocol
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - llm_network

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"  # Ollama API
    volumes:
      - ollama_data:/root/.ollama
      - ./ollama/entry_pull_models.sh:/ollama/entry_pull_models.sh:ro
    entrypoint: ["/bin/bash", "/ollama/entry_pull_models.sh"]
    environment:
      OLLAMA_HOST: 0.0.0.0:11434
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:11434/api/tags || curl -f http://localhost:11434/api/tags || exit 0"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    networks:
      - llm_network
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
        limits:
          memory: 8G

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: app
    ports:
      - "5000:5000"
    environment:
      # Redis configuration
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      REDIS_PASSWORD: ""
      
      # ClickHouse configuration
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_PORT: 8123
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""
      
      # Ollama configuration (using Ollama container)
      OLLAMA_HOST: http://ollama:11434
      
      # Flask configuration
      FLASK_APP: api/app.py
      FLASK_ENV: production
      PYTHONUNBUFFERED: 1
      # Fix NumPy CPU compatibility issue
      NPY_DISABLE_CPU_FEATURES: "X86_V2"
    volumes:
      - ./config:/app/config:ro  # Mount config directory as read-only
      - ./logs:/app/logs  # Mount logs directory for persistence
    depends_on:
      redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      ollama:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - llm_network
    restart: unless-stopped

volumes:
  redis_data:
    driver: local
  clickhouse_data:
    driver: local
  clickhouse_logs:
    driver: local
  ollama_data:
    driver: local

networks:
  llm_network:
    driver: bridge

